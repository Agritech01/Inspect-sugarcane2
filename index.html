<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBS Sugar - Dataการตรวจ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; }
        .kbs-header { background: #2E7D32; color: white; padding: 20px; border-bottom: 4px solid #FF9800; }
        .nav-link.active { background-color: #2E7D32 !important; color: white !important; }
        .table-container { background: white; border-radius: 10px; padding: 20px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="kbs-header text-center">
    <h3>ระบบติดตามโครงการปลูกอ้อย 69/70</h3>
    <small>ข้อมูลจากชีท: Dataการตรวจ</small>
</div>

<div class="container mt-4">
    <ul class="nav nav-pills mb-3 shadow-sm p-2 bg-white rounded" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" onclick="changeTab('ปลูกอ้อยในนา ปี 69/70', this)">ปลูกอ้อยในนา</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" onclick="changeTab('เปลี่ยนพืชอื่นมาปลูกอ้อย ปี 69/70', this)">เปลี่ยนพืชอื่น</button>
        </li>
    </ul>

    <div class="table-container">
        <div id="loader" class="text-center p-5">
            <div class="spinner-border text-success"></div>
            <p>กำลังโหลดข้อมูล...</p>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover border">
                <thead class="table-light">
                    <tr>
                        <th>เลขแปลง</th>
                        <th>ชื่อชาวไร่ (โควต้า)</th>
                        <th>เขต</th>
                        <th>นักเกษตร</th>
                        <th class="text-end">พื้นที่</th>
                        <th class="text-center">ผลการตรวจ</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ดึงจากชีท Dataการตรวจ โดยตรง
    const SHEET_ID = '2PACX-1vRY22UkMfLhAswqWJLCMvhCMeZxVsFQy1gLBLnrwB6VggruF4son8LZxN-EqtFxsUOdv1xs-Yf2cKnn';
    const GID = '1732816752'; 
    const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${GID}&output=csv`;

    let rawData = [];
    let activeProject = 'ปลูกอ้อยในนา ปี 69/70';

    async function loadData() {
        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            
            // แยกบรรทัดและล้างค่าว่าง
            const lines = text.split('\n').filter(l => l.trim() !== "");
            
            // เก็บเป็นข้อมูลดิบ (Array ของ Array) เพื่อลดความซับซ้อน
            rawData = lines.map(line => {
                // ใช้ Regex แยก CSV เพื่อป้องกันปัญหาเครื่องหมายคอมมาในชื่อ
                return line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
            });

            document.getElementById('loader').classList.add('d-none');
            render();
        } catch (err) {
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="6" class="text-center text-danger">เกิดข้อผิดพลาดในการดึงข้อมูล</td></tr>`;
        }
    }

    function render() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        const headers = rawData[0]; // แถวที่ 0 คือหัวตาราง
        
        // --- ใช้วิธีหาลำดับคอลัมน์เหมือนโค้ดเก่าคุณ ---
        const findCol = (name) => headers.findIndex(h => h.includes(name));
        
        const idxIntech = findCol("เลขแปลงintech");
        const idxQuota = findCol("เลขโควต้า");
        const idxFarmer = findCol("ชื่อชาวไร่");
        const idxZone = findCol("เขต");
        const idxStaff = findCol("ชื่อนักเกษตร");
        const idxArea = findCol("พื้นที่");
        const idxStatus = findCol("สถานะโครงการ"); // คอลัมน์ที่ใช้กรอง
        const idxAudit = findCol("เงื่อนไขโครงการ"); // คอลัมน์ผลการตรวจ

        // เริ่มวนลูปจากแถวที่ 1 (ข้ามหัวตาราง)
        const rows = rawData.slice(1);
        let foundCount = 0;

        rows.forEach(row => {
            // กรอง: ถ้าคอลัมน์ "สถานะโครงการ" ตรงกับแท็บที่เลือก
            if (row[idxStatus] === activeProject) {
                foundCount++;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-primary">${row[idxIntech] || '-'}</td>
                    <td>${row[idxFarmer] || '-'} <br><small class="text-muted">${row[idxQuota] || '-'}</small></td>
                    <td>${row[idxZone] || '-'}</td>
                    <td>${row[idxStaff] || '-'}</td>
                    <td class="text-end">${row[idxArea] || '0'}</td>
                    <td class="text-center">
                        <span class="badge ${row[idxAudit] === 'ผ่าน' ? 'bg-success' : 'bg-warning text-dark'}">
                            ${row[idxAudit] || 'รอตรวจ'}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });

        if (foundCount === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center p-5 text-muted">ไม่พบข้อมูล "${activeProject}"</td></tr>`;
        }
    }

    function changeTab(name, btn) {
        activeProject = name;
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    loadData();
</script>

</body>
</html>
